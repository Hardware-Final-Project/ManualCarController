# Manual Car Controller

🚗 **PIC18F 手動檔位遙控車系統** - 一個完整模擬日常車子換檔運作邏輯的微控制器項目

**原始碼連結**: [GitHub - ManualCarController](https://github.com/Hardware-Final-Project/ManualCarController.git)  
**YouTube 影片**: [專案演示](https://youtu.be/si4URYFhsps?si=6xCqTyb1RGR9YFmg)

## 📋 專案概述

本專案是一個搭載 **PIC18F 微控制器** 的手動檔位遙控車系統，透過藍芽（HC-06）無線遙控，實現了完整的汽車換檔機制模擬。與市面常見的直驅遙控車不同，本專案挑戰實體機械換檔設計，利用步進馬達驅動自製的齒條與連桿機構。

### 核心功能
- **油門控制** - 10 段前進 / 後退速度調整
- **機械換檔系統** - 2 檔位自動轉換邏輯（1檔 / 2檔）
- **手動檔位重置** - 精確控制步進馬達重置齒輪位置
- **OLED 實時顯示** - SSD1306 顯示當前速度與檔位
- **數位鑰匙** - 可變電阻作為車鑰匙開關
- **狀態指示 LED** - 顯示正反轉及相對速度

## 🏗️ 項目結構

```
ManualCarController/
├── main.c                    # 主程序入口
├── Makefile                  # 編譯配置
├── nbproject/                # NetBeans 項目配置
└── setting_hardaware/        # 硬件驅動層
    ├── adc.c/h              # ADC 模數轉換驅動
    ├── ccp.c/h              # 捕獲比較模塊
    ├── gear_shifting.c/h     # 檔位換挡邏輯
    ├── I2C.c/h              # I2C 通信協議
    ├── interrupt_manager.c/h # 中斷處理管理
    ├── pin_manager.c/h      # 引腳配置管理
    ├── setting.c/h          # 系統配置初始化
    ├── SSD1306.c/h          # OLED 顯示屏驅動
    ├── timer.c/h            # 定時器管理
    └── uart.c/h             # 串口通信驅動
```

## 🔧 主要功能模塊

### 1️⃣ 油門控制 (Throttle Control)
- **前進 (a~j)**: 輸入 10 段速度，PWM 輸出 0~500 給 CCP1（直流馬達）
- **後退 (l~u)**: 輸入 10 段速度，PWM 輸出 0~500 給 CCP2
- LED 指示燈顯示正反轉及相對速度

### 2️⃣ 機械換檔系統 (Gear Shifting)
```
輸入 A/B 進行檔位切換
- 1檔 → 2檔：步進馬達正向旋轉推動連桿
- 2檔 → 1檔：步進馬達反向旋轉拉回連桿

系統會參考上一檔位，判斷移動方向和秒數
```
- 步進馬達控制精度：0.1 秒為最小單位
- OLED 實時顯示當前檔位

### 3️⃣ 檔位重置模式 (Reset Gear)
```
輸入: R + rdxrty
- rd: 方向 (0=右, 1=左，從車頭看向車尾)
- rt: 秒數倍數 (0.1秒為單位)

例: Rd 表示向右移動 0.1秒
    R1d3 表示向左移動 0.3秒
```
用於手動調整步進馬達到精確位置

### 4️⃣ 數位鑰匙 (Digital Key)
- 可變電阻 (RA0) 作為鑰匙開關
- 轉到正中央時才能開始操控車輛
- 提供類似真實車鑰匙的交互體驗

### 5️⃣ I2C 顯示屏驅動 (SSD1306 OLED)
```
實時輸出內容:
- 換檔時: "Gear: [gear_num]"
- 變速時: "Speed: [speed_num]"  
- 重置時: "Reset Gear mode"
```

### 6️⃣ 馬達驅動與控制
- **A 馬達**: 直流馬達（變速/油門）- CCP1, CCP2 PWM 控制
- **B 馬達**: 步進馬達（換檔機構）- RD6, RD7 控制輸出
- **馬達驅動板**: L9110 雙通道馬達驅動模組

## 🏗️ 系統架構

### 軟件架構
```
Main Loop
├── 讀取藍芽輸入 (UART)
├── 判斷工作模式
│   ├── Mode 1: 油門控制
│   ├── Mode 2: 檔位換挡
│   └── Mode 3: 檔位重置
├── ADC 採樣 (可變電阻鑰匙)
├── I2C 輸出到 OLED
└── 中斷處理
    ├── Timer1: 步進馬達計時
    ├── UART: 藍芽接收
    └── 外部中斷
```

### 硬件架構
```
Bluetooth (HC-06)
    ↓
[PIC18F MCU]
    ├─→ PWM (CCP1/CCP2) → L9110 → 直流馬達 (變速)
    ├─→ GPIO (RD6/RD7) → 步進馬達驅動 → 步進馬達 (換檔)
    ├─→ ADC (RA0) ← 可變電阻 (鑰匙)
    ├─→ I2C (SDA/SCL) → SSD1306 OLED
    ├─→ GPIO → LED1, LED2 (狀態指示)
    └─→ UART (RX/TX) ← 已連接藍芽

電源系統:
2 × 3.7V 鋰電池 (7.4V) → 降壓板 → 5V (PIC18F & 周邊)
                         → 7.4V (馬達驅動)
```

## 📊 工作模式詳解

### 模式 1️⃣ - 油門控制 (Throttle Mode)
```
輸入: a~j (前進，10段) 或 l~u (後退，10段)
效果: 
  - 直流馬達速度調整
  - PWM 占空比 0~500
  - LED 顯示轉速和方向
```

### 模式 2️⃣ - 檔位換挡 (Gear Shifting Mode)
```
輸入: A 或 B
效果:
  - 自動判斷當前檔位和目標檔位
  - 步進馬達驅動連桿機構移動
  - 根據上次檔位自動計算移動秒數
  - OLED 顯示新檔位
  - 伴隨可聽見的齒輪嚙合聲
```

### 模式 3️⃣ - 檔位重置 (Reset Gear Mode)
```
輸入: R + rdxrty 
      (rd: 方向 0/1, rt: 0.1秒倍數)
效果:
  - 精確控制步進馬達移動距離
  - 調整齒輪到任意位置
  - OLED 顯示 "Reset Gear mode"
```

## 👥 團隊分工

**小組名稱**: PIC18F Manual Car - 第十組

| 成員 | 主要貢獻 |
|------|--------|
| **余嘉憲** | 換檔機構設計、OLED 顯示、車子操作邏輯 & 程式碼、換檔除錯、電路設計、車體部件設計 |
| **丁泓元** | OnShape 車體設計、馬達控制邏輯 & 程式碼、藍芽控制邏輯 & 程式碼、電路設計 |
| **曾令城** | 變速機構實作、車體結構組裝、電路設計、流程圖繪製、文件整合、可變電阻鑰匙設計 |
| **黃威誠** | 車體切割與設計、結構強化與組裝、零件加工、電路設計 |

## 📦 材料與技術清單

### 電子元件
- PIC18F 微控制器
- HC-06 藍芽模組
- SSD1306 OLED 顯示屏
- L9110 雙通道馬達驅動模組
- 直流馬達 (變速)
- 步進馬達 (換檔)
- 3.7V 鋰電池 × 2
- 降壓板 (5V)
- 三顆電容 (濾波)

### 機械部件
- 齒輪組 (傳動)
- 傳動軸與軸套
- 優塑板
- 塑膠積木零件
- 尺條與連桿機構
- 輪子

### 開發工具
- MPLAB X IDE
- MPLAB C18 編譯器
- OnShape (車體設計)
- 焊接槍 (焊接電子元件)
- 美工刀 (切割板子)

## 📚 核心代碼模塊

### setting_hardaware/ 目錄說明

| 文件 | 功能 |
|------|------|
| `setting.c/h` | 系統初始化，各模塊配置 |
| `pin_manager.c/h` | 引腳配置和 I/O 管理 |
| `uart.c/h` | UART 串口通信 (藍芽) |
| `I2C.c/h` | I2C 主機模式 (OLED 控制) |
| `SSD1306.c/h` | SSD1306 OLED 顯示屏驅動 |
| `adc.c/h` | ADC 模數轉換 (可變電阻鑰匙) |
| `ccp.c/h` | 捕獲比較模塊 (CCP1/CCP2 PWM) |
| `timer.c/h` | Timer 定時器管理 |
| `interrupt_manager.c/h` | 中斷管理與處理 |
| `gear_shifting.c/h` | 換檔邏輯與狀態管理 |

### 關鍵全局變量 (main.c)
```c
char mode = 0;           // 工作模式 (1=油門, 2=換檔, 3=重置)
unsigned int duty1 = 0;  // CCP1 PWM 占空比 (前進)
unsigned int duty2 = 0;  // CCP2 PWM 占空比 (後退)
char gear_mode = 1;      // 當前檔位 (1 或 2)
char prev_gear_mode = 1; // 上一檔位 (用於判斷移動方向)
char direction = 0;      // 方向標誌
```

## 🔌 硬件接口與外設

| 接口 | 用途 | 說明 |
|------|------|------|
| **RA0** | 可變電阻 (ADC) | 數位鑰匙，轉到中點才能啟動 |
| **CCP1/CCP2** | PWM 輸出 | 直流馬達速度控制 (0~500 占空比) |
| **RD6/RD7** | GPIO 輸出 | 步進馬達控制腳位 |
| **RX/TX** | UART | 藍芽模組 (HC-06) 通信 |
| **SDA/SCL** | I2C Master | SSD1306 OLED 顯示屏 |
| **Timer1** | 中斷 | 0.1 秒延遲，用於步進馬達計時 |
| **LED1/LED2** | GPIO 輸出 | 速度和方向狀態指示燈 |

### PWM 占空比映射
```
CCP1 (前進): (min) 0 ~ 500 (max)
CCP2 (後退): (min) 0 ~ 500 (max)

輸入 a~j:  對應 PWM 值 50, 100, 150, ..., 500 (CCP1)
輸入 l~u:  對應 PWM 值 50, 100, 150, ..., 500 (CCP2)
```

## 📖 使用說明

### 快速開始指南
1. **啟動車輛**: 打開藍芽，轉動可變電阻到中點位置（鑰匙功能）
2. **連接藍芽**: 手機配對 HC-06 藍芽模組 (預設密碼通常為 1234 或 0000)
3. **發送指令**: 使用藍芽終端應用程式發送指令

### 指令表
| 指令 | 功能 | 範圍 |
|------|------|------|
| `a~j` | 前進 1~10 檔 | 10 段速度 |
| `l~u` | 後退 1~10 檔 | 10 段速度 |
| `A` | 切換到 1 檔 | - |
| `B` | 切換到 2 檔 | - |
| `R` + `rdxrty` | 手動重置檔位 | 方向 + 時間 |

### 實際操作範例
```
場景 1: 前進最高速
發送: j
效果: PWM = 500 (最高速), OLED 顯示 "Speed: 10"

場景 2: 從 1 檔切到 2 檔
發送: B
效果: 步進馬達推動連桿, OLED 顯示 "Gear: 2"

場景 3: 重置檔位向右 0.3 秒
發送: R0d3
效果: 步進馬達向右旋轉 3 × 0.1秒

場景 4: 後退中速
發送: r (約 5 檔)
效果: PWM = 250 (中速後退), OLED 顯示 "Speed: 5"
```

## 💡 設計創新與挑戰

### 🏆 創新亮點
1. **自製模擬手排變速箱**
   - 不同於市面常見的直驅遙控車，本專案挑戰實體機械換檔
   - 利用步進馬達驅動自製齒條與連桿機構
   - 完全自主設計的換檔機制，材料難以取得都需手做

2. **數位鑰匙系統**
   - 使用可變電阻模擬真實車鑰匙功能
   - 提供類似真實車的交互體驗

3. **完整的微控制器應用**
   - 多種外設完整整合（PWM、I2C、UART、ADC、Timer、中斷）
   - 實現複雜的控制邏輯

### 🔧 遇到的主要困難與解決方案

#### 車體相關
| 困難 | 解決方案 |
|------|--------|
| 車體設計方案 | 發現優塑板的孔洞結構與車軸相容，可作為軸轉動空間 |
| 一體式結構設計 | 從不穩定的兩體式架構改良為一體式結構 |
| 換檔時抖動問題 | 使用束帶頭填塞孔隙，防止車軸晃動 |
| 步進馬達驅動方式 | 採用步進馬達 + 尺條 + 連桿結構方案（空間考量） |
| 強度不足問題 | 更換為塑膠積木零件 + 金屬車軸/軸套 |

#### 電路相關
| 困難 | 解決方案 |
|------|--------|
| 馬達卡死大電流導致藍芽重啟 | 三顆電容並聯在降壓板輸出 |
| 電壓超出 PIC18F 承受範圍 | 採用降壓模組 (LM1117 等) |
| 沒有回授電路無法精準換檔 | 人工手測 Timer 秒數（根據電池電流調整） |

#### 軟件相關
- 換檔邏輯複雜度高，需反覆調試測試
- 步進馬達計時精度要求 0.1 秒準確度
- 檔位狀態管理與記錄

## 🎓 基礎與進階單元應用

### 基礎單元
- **Interrupt (中斷)**
  - Timer1: 步進馬達精確計時 (0.1 秒為單位)
  - UART: 藍芽接收中斷驅動讀取

- **Timer (定時器)**
  - Timer1: 提供 0.1 秒延遲計時，用於步進馬達步數控制

- **ADC (模數轉換)**
  - RA0 通道: 可變電阻採樣，實現數位鑰匙功能

- **PWM (脈衝寬度調變)**
  - CCP1, CCP2: 控制直流馬達轉速 (占空比 0~500)
  - LED 並聯顯示正反轉與相對速度

- **UART (串行通信)**
  - HC-06 藍芽模組通信
  - 指令接收與解析

- **I2C (序列通信)**
  - Master 模式
  - SSD1306 OLED 控制與顯示

### 進階單元
- **穩壓與濾波**
  - 三顆電容並聯在降壓板輸出
  - 阻擋馬達卡死產生的大電流，保護藍芽模組

- **複雜狀態管理**
  - 檔位自動判斷邏輯
  - 馬達移動方向與秒數計算

- **實體機械控制**
  - 步進馬達精確控制
  - 連桿機構的動力傳遞優化
